<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loot Spin Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comfortaa', cursive;
      background: linear-gradient(to bottom, #1e1e2f, #0f0f1a);
      color: #ffffff;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 40px auto;
      max-width: 1400px;
      position: relative;
    }

    .ascension-shop, .upgrade-altar {
      width: 250px;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
      text-align: center;
    }

    .ascension-shop h2, .upgrade-altar h2 {
      font-size: 1.8em;
      margin-top: 0;
    }

    .forge-slots, .fuel-slots {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    .forge-slot, .target-slot, .fuel-slot {
      width: 100%;
      height: 60px;
      border: 2px dashed #888;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      background: rgba(255,255,255,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }

    .forge-slot:hover, .target-slot:hover, .fuel-slot:hover {
      transform: scale(1.02);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .forge-button, .upgrade-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Comfortaa', cursive;
    }

    .forge-button:hover, .upgrade-button:hover {
      background: #ff4d94;
    }

    .batch-selection {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 10px;
    }

    .batch-selection select, .batch-selection button {
      padding: 6px;
      font-size: 0.8em;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #888;
      border-radius: 5px;
      color: #fff;
      font-family: 'Comfortaa', cursive;
    }

    .batch-selection button {
      background: #00c3ff;
      border: none;
      cursor: pointer;
    }

    .batch-selection button:hover {
      background: #00a3dd;
    }

    .changelog {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 15px;
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #dc143c rgba(255, 255, 255, 0.1);
      text-align: left;
    }

    .changelog::-webkit-scrollbar {
      width: 8px;
    }

    .changelog::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .changelog::-webkit-scrollbar-thumb {
      background: #dc143c;
      border-radius: 10px;
    }

    .changelog::-webkit-scrollbar-thumb:hover {
      background: #b01030;
    }

    .changelog h3 {
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
      margin-top: 0;
    }

    .changelog ul {
      list-style-type: none;
      padding-left: 0;
      margin: 0;
    }

    .changelog li {
      padding: 8px;
      margin: 5px 0;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
    }

    .changelog a {
      color: #00c3ff;
      text-decoration: underline;
      cursor: pointer;
    }

    .changelog a:hover {
      color: #00a3dd;
    }

    .game-container {
      max-width: 600px;
      background: rgba(255, 255, 255, 0.05);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
      position: relative;
      z-index: 1;
    }

    h1 {
      margin-top: 0;
      font-size: 2.5em;
    }

    .spin-button {
      padding: 15px 40px;
      font-size: 1.2em;
      font-weight: bold;
      background: #00c3ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 15px #00c3ff;
      transition: background 0.3s;
      font-family: 'Comfortaa', cursive;
    }

    .spin-button:hover {
      background: #00a3dd;
    }

    .item-card {
      margin-top: 30px;
      padding: 20px;
      border-radius: 15px;
      display: inline-block;
      font-size: 1.2em;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
      width: 280px;
    }

    /* Rarity styles for item cards */
    .Common { 
      background: #bdc3c7; 
      color: #2c3e50; 
      box-shadow: 0 0 10px rgba(189, 195, 199, 0.7);
    }

    .Uncommon { 
      background: #2ecc71; 
      color: #fff; 
      box-shadow: 0 0 12px rgba(46, 204, 113, 0.7);
    }

    .Rare { 
      background: #3498db; 
      color: #fff; 
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.7);
    }

    .SuperRare { 
      background: #e67e22; 
      color: #fff; 
      box-shadow: 0 0 15px rgba(230, 126, 34, 0.7);
    }

    .Epic { 
      background: #9b59b6; 
      color: #fff; 
      box-shadow: 0 0 15px rgba(155, 89, 182, 0.7);
    }

    .Legendary { 
      background: #f1c40f; 
      color: #000; 
      box-shadow: 0 0 20px rgba(241, 196, 15, 0.7);
    }

    .Mythical { 
      background: #ff69b4; 
      color: #fff; 
      box-shadow: 0 0 22px rgba(255, 105, 180, 0.7);
    }

    .Celestial { 
      background: #00f7ff; 
      color: #000; 
      box-shadow: 0 0 25px rgba(0, 247, 255, 0.8);
    }

    .Special { 
      background: #dc143c;
      color: #fff;
      box-shadow: 0 0 25px rgba(220, 20, 60, 0.8);
    }

    /* Inventory and list item variants */
    .Common-li { background: rgba(189, 195, 199, 0.7); }
    .Uncommon-li { background: rgba(46, 204, 113, 0.7); }
    .Rare-li { background: rgba(52, 152, 219, 0.7); }
    .SuperRare-li { background: rgba(230, 126, 34, 0.7); }
    .Epic-li { background: rgba(155, 89, 182, 0.7); }
    .Legendary-li { background: rgba(241, 196, 15, 0.7); }
    .Mythical-li { background: rgba(255, 105, 180, 0.7); }
    .Celestial-li { background: rgba(0, 247, 255, 0.7); }
    .Special-li { background: rgba(220, 20, 60, 0.7); }

    .inventory, .forgable-list, .fuel-card-list, .changelog {
      margin-top: 20px;
      text-align: left;
      background: rgba(255, 255, 255, 0.03);
      padding: 15px;
      border-radius: 15px;
      max-height: 250px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #dc143c rgba(255, 255, 255, 0.1);
    }

    .inventory::-webkit-scrollbar, .forgable-list::-webkit-scrollbar, .fuel-card-list::-webkit-scrollbar, .changelog::-webkit-scrollbar {
      width: 8px;
    }

    .inventory::-webkit-scrollbar-track, .forgable-list::-webkit-scrollbar-track, .fuel-card-list::-webkit-scrollbar-track, .changelog::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .inventory::-webkit-scrollbar-thumb, .forgable-list::-webkit-scrollbar-thumb, .fuel-card-list::-webkit-scrollbar-thumb, .changelog::-webkit-scrollbar-thumb {
      background: #dc143c;
      border-radius: 10px;
    }

    .inventory::-webkit-scrollbar-thumb:hover, .forgable-list::-webkit-scrollbar-thumb:hover, .fuel-card-list::-webkit-scrollbar-thumb:hover, .changelog::-webkit-scrollbar-thumb:hover {
      background: #b01030;
    }

    .inventory h3, .forgable-list h3, .fuel-card-list h3, .changelog h3 {
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }

    .inventory ul, .forgable-list ul, .fuel-card-list ul, .changelog ul {
      list-style-type: none;
      padding-left: 0;
      margin: 0;
    }

    .inventory li, .forgable-list li, .fuel-card-list li, .changelog li {
      padding: 8px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .inventory li:hover, .forgable-list li:hover, .fuel-card-list li:hover {
      transform: scale(1.02);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .inventory li.selected, .forgable-list li.selected, .fuel-card-list li.selected {
      border: 2px solid #00f7ff;
      box-shadow: 0 0 15px rgba(0, 247, 255, 0.8);
    }

    .inventory li.forged-card {
      animation: glow 1s ease-in-out;
    }

    .tooltip {
      visibility: hidden;
      background-color: rgba(0, 0, 0, 0.9);
      color: #fff;
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 100;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      font-size: 0.9em;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .inventory li:hover .tooltip, .forgable-list li:hover .tooltip, .fuel-card-list li:hover .tooltip, .target-slot:hover .tooltip, .fuel-slot:hover .tooltip {
      visibility: visible;
    }

    .slots {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .slot {
      width: 100px;
      height: 100px;
      border: 2px dashed #888;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      background: rgba(255,255,255,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .slot:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .slot-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 5px;
      box-sizing: border-box;
    }

    .forge-slot.Common { background: #bdc3c7; color: #2c3e50; }
.forge-slot.Uncommon { background: #2ecc71; color: #fff; }
.forge-slot.Rare { background: #3498db; color: #fff; }
.forge-slot.SuperRare { background: #e67e22; color: #fff; }
.forge-slot.Epic { background: #9b59b6; color: #fff; }
.forge-slot.Legendary { background: #f1c40f; color: #000; }
.forge-slot.Mythical { background: #ff69b4; color: #fff; }
.forge-slot.Celestial { background: #00f7ff; color: #000; }
.forge-slot.Special { background: #dc143c; color: #fff; }

.target-slot.Common { background: #bdc3c7; color: #2c3e50; }
.target-slot.Uncommon { background: #2ecc71; color: #fff; }
.target-slot.Rare { background: #3498db; color: #fff; }
.target-slot.SuperRare { background: #e67e22; color: #fff; }
.target-slot.Epic { background: #9b59b6; color: #fff; }
.target-slot.Legendary { background: #f1c40f; color: #000; }
.target-slot.Mythical { background: #ff69b4; color: #fff; }
.target-slot.Celestial { background: #00f7ff; color: #000; }
.target-slot.Special { background: #dc143c; color: #fff; }

.fuel-slot.Common { background: #bdc3c7; color: #2c3e50; }
.fuel-slot.Uncommon { background: #2ecc71; color: #fff; }
.fuel-slot.Rare { background: #3498db; color: #fff; }
.fuel-slot.SuperRare { background: #e67e22; color: #fff; }
.fuel-slot.Epic { background: #9b59b6; color: #fff; }
.fuel-slot.Legendary { background: #f1c40f; color: #000; }
.fuel-slot.Mythical { background: #ff69b4; color: #fff; }
.fuel-slot.Celestial { background: #00f7ff; color: #000; }
.fuel-slot.Special { background: #dc143c; color: #fff; }

.forge-slot, .target-slot, .fuel-slot, .slot-content {
  background: none !important;
}

/* Ensure rarity-specific backgrounds for slots */
.forge-slot.Common, .target-slot.Common, .fuel-slot.Common, .slot-content.Common {
  background: #bdc3c7 !important; color: #2c3e50 !important;
}
.forge-slot.Uncommon, .target-slot.Uncommon, .fuel-slot.Uncommon, .slot-content.Uncommon {
  background: #2ecc71 !important; color: #fff !important;
}
.forge-slot.Rare, .target-slot.Rare, .fuel-slot.Rare, .slot-content.Rare {
  background: #3498db !important; color: #fff !important;
}
.forge-slot.SuperRare, .target-slot.SuperRare, .fuel-slot.SuperRare, .slot-content.SuperRare {
  background: #e67e22 !important; color: #fff !important;
}
.forge-slot.Epic, .target-slot.Epic, .fuel-slot.Epic, .slot-content.Epic {
  background: #9b59b6 !important; color: #fff !important;
}
.forge-slot.Legendary, .target-slot.Legendary, .fuel-slot.Legendary, .slot-content.Legendary {
  background: #f1c40f !important; color: #000 !important;
}
.forge-slot.Mythical, .target-slot.Mythical, .fuel-slot.Mythical, .slot-content.Mythical {
  background: #ff69b4 !important; color: #fff !important;
}
.forge-slot.Celestial, .target-slot.Celestial, .fuel-slot.Celestial, .slot-content.Celestial {
  background: #00f7ff !important; color: #000 !important;
}
.forge-slot.Special, .target-slot.Special, .fuel-slot.Special, .slot-content.Special {
  background: #dc143c !important; color: #fff !important;
}

#batchRarity, #batchRarity option {
  color: #000 !important;
}
#batchRarity option[value="Common"] { background: #bdc3c7 !important; }
#batchRarity option[value="Uncommon"] { background: #2ecc71 !important; }
#batchRarity option[value="Rare"] { background: #3498db !important; }
#batchRarity option[value="SuperRare"] { background: #e67e22 !important; }
#batchRarity option[value="Epic"] { background: #9b59b6 !important; }
#batchRarity option[value="Legendary"] { background: #f1c40f !important; }
#batchRarity option[value="Mythical"] { background: #ff69b4 !important; }
#batchRarity option[value="Celestial"] { background: #00f7ff !important; }
#batchRarity option[value="Special"] { background: #dc143c !important; }

#batchCPS {
  padding: 6px;
  font-size: 0.8em;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid #888;
  border-radius: 5px;
  color: #fff;
  font-family: 'Comfortaa', cursive;
  width: 100px;
  transition: border-color 0.2s ease;
}

#batchCPS:focus {
  border-color: #00c3ff;
  outline: none;
}

#batchCPS:invalid {
  border-color: #dc143c;
}

    .slot .tooltip {
      bottom: auto;
      top: 100%;
    }

    .coin-counter {
      font-size: 1.3em;
      margin-bottom: 20px;
    }

    .coin-counter.sparkle {
      animation: sparkle 0.5s ease-in-out;
    }
    
    .description-text {
      font-size: 0.8em;
      margin-top: 5px;
      font-style: italic;
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      pointer-events: none;
      z-index: 1000;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      pointer-events: none;
      z-index: 1000;
      border-radius: 2px;
    }

    .special-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .special-content {
      background: rgba(30, 30, 47, 0.95);
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 450px;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.5);
    }

    .special-title {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 15px;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .special-title.Celestial {
      color: #00f7ff;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.8), 0 0 12px rgba(0, 247, 255, 0.6);
      background: rgba(0, 0, 0, 0.3);
    }

    .special-title.Special {
      color: #dc143c;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.8), 0 0 12px rgba(220, 20, 60, 0.6);
      background: rgba(0, 0, 0, 0.3);
    }

    .special-item {
      font-size: 1.5em;
      font-weight: bold;
      margin: 15px 0;
    }

    .close-special {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      background: #dc143c;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Comfortaa', cursive;
    }

    .close-special:hover {
      background: #b01030;
    }

    .code-redeemer {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 10px;
    }

    .code-redeemer input {
      padding: 6px;
      font-size: 0.8em;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #888;
      border-radius: 5px;
      color: #fff;
      font-family: 'Comfortaa', cursive;
      flex: 1;
      max-width: 120px;
    }

    .code-redeemer button {
      padding: 6px 12px;
      font-size: 0.8em;
      background: #00c3ff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Comfortaa', cursive;
    }

    .code-redeemer button:hover {
      background: #00a3dd;
    }

    .save-load {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 10px;
    }

    .save-load textarea {
      padding: 6px;
      font-size: 0.8em;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #888;
      border-radius: 5px;
      color: #fff;
      font-family: 'Comfortaa', cursive;
      width: 100%;
      resize: none;
      height: 60px;
    }

    .save-load button {
      padding: 6px 12px;
      font-size: 0.8em;
      background: #00c3ff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Comfortaa', cursive;
    }

    .save-load button:hover {
      background: #00a3dd;
    }

    @keyframes glow {
      0% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 0, 1); }
      100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
    }

    @keyframes sparkle {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="confetti-container" id="confettiContainer"></div>
  <div class="container">
    <div class="ascension-shop">
      <h2>üîÆ Ascension Shop</h2>
      <div class="forge-slots" id="forgeSlots">
        <div class="forge-slot" data-slot="0">Forge Slot 1</div>
        <div class="forge-slot" data-slot="1">Forge Slot 2</div>
        <div class="forge-slot" data-slot="2">Forge Slot 3</div>
      </div>
      <button class="forge-button" onclick="forgeCards()">Forge Cards</button>
      <div class="code-redeemer">
        <input type="text" id="codeInput" placeholder="Enter code">
        <button onclick="redeemCode()">Redeem</button>
      </div>
      <div class="save-load">
        <textarea id="saveCode" placeholder="Save/load code here"></textarea>
        <div style="display: flex; gap: 10px;">
          <button onclick="saveGame(true)">Save Game</button>
          <button onclick="loadGame()">Load Game</button>
        </div>
      </div>
      <div class="forgable-list">
        <h3>üõ†Ô∏è Forgable Items:</h3>
        <ul id="forgableList"></ul>
      </div>
    </div>
    <div class="game-container">
      <h1>üé∞ Loot Spin</h1>
      <div class="coin-counter">üí∞ Coins: <span id="coinCounter">100</span></div>
      <button class="spin-button" onclick="spin()">Spin (Cost: <span id="spinCost">10</span> Coins)</button>
      <div id="result" class="item-card"></div>
      <div class="slots" id="slots">
        <div class="slot" data-slot="0"><div class="slot-content">Slot 1</div></div>
        <div class="slot" data-slot="1"><div class="slot-content">Slot 2</div></div>
        <div class="slot" data-slot="2"><div class="slot-content">Slot 3</div></div>
        <div class="slot" data-slot="3"><div class="slot-content">Slot 4</div></div>
        <div class="slot" data-slot="4"><div class="slot-content">Slot 5</div></div>
      </div>
      <div class="inventory">
        <h3>üéí Inventory:</h3>
        <ul id="inventoryList"></ul>
      </div>
    </div>
    <div class="upgrade-altar">
      <h2>üî• Upgrade Altar</h2>
      <div class="target-slot" id="altarTarget">Target Slot</div>
      <div class="fuel-slots" id="fuelSlots">
        <div class="fuel-slot" data-slot="0">Fuel Slot 1</div>
        <div class="fuel-slot" data-slot="1">Fuel Slot 2</div>
        <div class="fuel-slot" data-slot="2">Fuel Slot 3</div>
        <div class="fuel-slot" data-slot="3">Fuel Slot 4</div>
        <div class="fuel-slot" data-slot="4">Fuel Slot 5</div>
      </div>
      <button class="upgrade-button" onclick="upgradeCard()">Upgrade Card</button>
      <div class="batch-selection">
        <select id="batchRarity">
          <option value="">Select Rarity</option>
          <option value="Common">Common</option>
          <option value="Uncommon">Uncommon</option>
          <option value="Rare">Rare</option>
          <option value="SuperRare">SuperRare</option>
          <option value="Epic">Epic</option>
          <option value="Legendary">Legendary</option>
          <option value="Mythical">Mythical</option>
          <option value="Celestial">Celestial</option>
          <option value="Special">Special</option>
        </select>
        <input type="number" id="batchCPS" min="0" placeholder="Enter CPS (0-1000)" title="Enter a CPS value between 0 and 1000">
        <button onclick="batchSelectFuelCards()">Select</button>
      </div>
      <div class="fuel-card-list">
        <h3>‚õΩ Fuel Cards:</h3>
        <ul id="fuelCardList"></ul>
      </div>
      <div class="changelog">
        <h3>üìú Changelog & Credits</h3>
        <ul id="changelogList"></ul>
      </div>
    </div>
  </div>

  <script>
    let coins = 100;
    let spinCost = 10;
    const inventory = [];
    const equipped = [null, null, null, null, null];
    const forgeSlots = [null, null, null];
    let altarTarget = null;
    const altarFuel = [null, null, null, null, null];
    let selectedItem = null;
    let selectedSource = null; // 'inventory', 'forgable', or 'fuel'
    const redeemedCodes = new Set();
    const changelog = [];
    const rarityOrder = { 
      Special: 9, 
      Celestial: 8, 
      Mythical: 7, 
      Legendary: 6, 
      Epic: 5, 
      SuperRare: 4, 
      Rare: 3, 
      Uncommon: 2, 
      Common: 1 
    };
    const rarityProgression = [
      'Common', 'Uncommon', 'Rare', 'SuperRare', 
      'Epic', 'Legendary', 'Mythical', 'Celestial'
    ];

    const items = [
      // Common Items (40% total chance, 12 items)
      { name: "Chocolate Frog", rarity: "Common", emoji: "üê∏", cps: 1, chance: 0.05, description: "A sweet that hops around, comes with a wizard card." },
      { name: "Bertie Bott's Beans", rarity: "Common", emoji: "üç¨", cps: 1, chance: 0.05, description: "Jelly beans with flavors like earwax or chocolate." },
      { name: "Hogwarts Letter", rarity: "Common", emoji: "‚úâÔ∏è", cps: 2, chance: 0.04, description: "Your acceptance letter to Hogwarts!" },
      { name: "Broken Wand", rarity: "Common", emoji: "ü™Ñ", cps: 1, chance: 0.04, description: "Sparks occasionally, but unreliable." },
      { name: "Old Cauldron", rarity: "Common", emoji: "‚öóÔ∏è", cps: 2, chance: 0.04, description: "Dented but functional for basic potions." },
      { name: "Potion Book", rarity: "Common", emoji: "üìñ", cps: 1, chance: 0.03, description: "Contains recipes for simple potions." },
      { name: "Scabbers", rarity: "Common", emoji: "üêÄ", cps: 1, chance: 0.03, description: "Ron's suspicious pet rat." },
      { name: "Quill", rarity: "Common", emoji: "‚úçÔ∏è", cps: 1, chance: 0.03, description: "A standard feather quill for spell writing." },
      { name: "Parchment", rarity: "Common", emoji: "üìú", cps: 1, chance: 0.03, description: "Used for homework and spell notes." },
      { name: "Hogwarts Textbook", rarity: "Common", emoji: "üìö", cps: 2, chance: 0.02, description: "A basic spellbook or history text." },
      { name: "Pumpkin Pasty", rarity: "Common", emoji: "ü•ü", cps: 1, chance: 0.02, description: "A savory snack from the Hogwarts Express." },
      { name: "Sneakoscope", rarity: "Common", emoji: "üîç", cps: 1, chance: 0.02, description: "Spins when someone untrustworthy is near." },

      // Uncommon Items (25% total chance, 10 items)
      { name: "Marauder's Map", rarity: "Uncommon", emoji: "üó∫Ô∏è", cps: 3, chance: 0.04, description: "Shows everyone's location at Hogwarts." },
      { name: "Extendable Ears", rarity: "Uncommon", emoji: "üëÇ", cps: 3, chance: 0.04, description: "Eavesdrop through walls with these." },
      { name: "Fizzing Whizbees", rarity: "Uncommon", emoji: "üçØ", cps: 2, chance: 0.03, description: "Sweets that make you levitate slightly." },
      { name: "Nimbus 2000", rarity: "Uncommon", emoji: "üßπ", cps: 4, chance: 0.03, description: "A decent Quidditch broom." },
      { name: "Remembrall", rarity: "Uncommon", emoji: "üîÆ", cps: 2, chance: 0.03, description: "Glows red when you forget something." },
      { name: "Quick-Quotes Quill", rarity: "Uncommon", emoji: "‚úçÔ∏è", cps: 3, chance: 0.02, description: "Writes exaggerated stories automatically." },
      { name: "Hogsmeade Permission", rarity: "Uncommon", emoji: "üìù", cps: 2, chance: 0.02, description: "Grants access to Hogsmeade weekends." },
      { name: "Butterbeer", rarity: "Uncommon", emoji: "üç∫", cps: 2, chance: 0.02, description: "A frothy, non-alcoholic drink." },
      { name: "Gobstones", rarity: "Uncommon", emoji: "üé≤", cps: 2, chance: 0.01, description: "A game that squirts losers with goo." },
      { name: "Spellotape", rarity: "Uncommon", emoji: "ü©π", cps: 2, chance: 0.01, description: "Magical tape for fixing wands." },

      // Rare Items (15% total chance, 8 items)
      { name: "Invisibility Cloak", rarity: "Rare", emoji: "üß•", cps: 5, chance: 0.03, description: "Hides you from most eyes." },
      { name: "Time-Turner", rarity: "Rare", emoji: "‚è≥", cps: 6, chance: 0.025, description: "Travel back in time, use cautiously." },
      { name: "Howler", rarity: "Rare", emoji: "üî¥", cps: 4, chance: 0.02, description: "Screams its message at the recipient." },
      { name: "Firebolt", rarity: "Rare", emoji: "üßπ", cps: 7, chance: 0.02, description: "The fastest Quidditch broom ever." },
      { name: "Deluminator", rarity: "Rare", emoji: "üí°", cps: 5, chance: 0.015, description: "Steals and stores light." },
      { name: "Polyjuice Potion", rarity: "Rare", emoji: "üß™", cps: 6, chance: 0.015, description: "Transform into someone else for an hour." },
      { name: "Sneakoscope", rarity: "Rare", emoji: "üîç", cps: 4, chance: 0.01, description: "A more reliable dark detector." },
      { name: "Mandrake", rarity: "Rare", emoji: "üå±", cps: 5, chance: 0.01, description: "Its cry is fatal, handle with care." },

      // Super Rare Items (10% total chance, 6 items)
      { name: "Felix Felicis", rarity: "SuperRare", emoji: "üçÄ", cps: 10, chance: 0.025, description: "Liquid luck for a perfect day." },
      { name: "Triwizard Cup", rarity: "SuperRare", emoji: "üèÜ", cps: 12, chance: 0.02, description: "Glows with tournament magic." },
      { name: "Thestral", rarity: "SuperRare", emoji: "üêé", cps: 11, chance: 0.02, description: "Only visible to those who‚Äôve seen death." },
      { name: "Pensieve", rarity: "SuperRare", emoji: "ü™£", cps: 10, chance: 0.015, description: "View and analyze memories." },
      { name: "Mirror of Erised", rarity: "SuperRare", emoji: "ü™û", cps: 9, chance: 0.01, description: "Shows your heart‚Äôs deepest desire." },
      { name: "Mad-Eye‚Äôs Eye", rarity: "SuperRare", emoji: "üëÅÔ∏è", cps: 10, chance: 0.01, description: "Sees through walls and cloaks." },

      // Epic Items (5% total chance, 5 items)
      { name: "Phoenix Feather", rarity: "Epic", emoji: "üî•", cps: 15, chance: 0.015, description: "Bursts with regenerative magic." },
      { name: "Goblet of Fire", rarity: "Epic", emoji: "üî•", cps: 16, chance: 0.012, description: "Chooses worthy champions." },
      { name: "Veil", rarity: "Epic", emoji: "üö™", cps: 14, chance: 0.01, description: "A mysterious archway to the beyond." },
      { name: "Room of Requirement", rarity: "Epic", emoji: "üè∞", cps: 15, chance: 0.008, description: "Appears when you need it most." },
      { name: "Patronus Charm", rarity: "Epic", emoji: "ü¶å", cps: 13, chance: 0.005, description: "Summons a protective spirit." },

      // Legendary Items (3% total chance, 4 items)
      { name: "Elder Wand", rarity: "Legendary", emoji: "üåü", cps: 20, chance: 0.01, description: "The most powerful wand in existence." },
      { name: "Resurrection Stone", rarity: "Legendary", emoji: "ü™ô", cps: 18, chance: 0.008, description: "Summons shadows of the dead." },
      { name: "Cloak of Invisibility", rarity: "Legendary", emoji: "üï¥Ô∏è", cps: 22, chance: 0.007, description: "True invisibility, a Deathly Hallow." },
      { name: "Sword of Gryffindor", rarity: "Legendary", emoji: "‚öîÔ∏è", cps: 25, chance: 0.005, description: "Appears to worthy Gryffindors." },

      // Mythical Items (1.5% total chance, 3 items)
      { name: "Horcrux", rarity: "Mythical", emoji: "üíç", cps: 30, chance: 0.006, description: "A dark object containing a soul fragment." },
      { name: "Philosopher‚Äôs Stone", rarity: "Mythical", emoji: "ü™®", cps: 35, chance: 0.005, description: "Grants immortality and gold." },
      { name: "Fawkes", rarity: "Mythical", emoji: "ü¶Ö", cps: 32, chance: 0.004, description: "Dumbledore‚Äôs loyal phoenix." },

      // Celestial Items (0.5% total chance, 2 items)
      { name: "Deathly Hallows", rarity: "Celestial", emoji: "üî∫", cps: 50, chance: 0.003, description: "Mastery over death itself." },
      { name: "Hogwarts Castle", rarity: "Celestial", emoji: "üè∞", cps: 60, chance: 0.002, description: "The magical heart of the wizarding world." },

      // Special Items (0.4% total chance, 5 items)
      { name: "Harry‚Äôs Scar", rarity: "Special", emoji: "‚ö°Ô∏è", cps: 70, chance: 0.0015, description: "A mark of survival and connection to Voldemort." },
      { name: "Dumbledore‚Äôs Army", rarity: "Special", emoji: "ü™ñ", cps: 65, chance: 0.001, description: "A rebellious group of brave students." },
      { name: "Snitch", rarity: "Special", emoji: "üèê", cps: 60, chance: 0.001, description: "The elusive prize of Quidditch." },
      { name: "Sorting Hat", rarity: "Special", emoji: "üé©", cps: 75, chance: 0.0005, description: "Chooses your Hogwarts house with wisdom." },
      { name: "Professor McGonagall", rarity: "Special", emoji: "üßô‚Äç‚ôÄÔ∏è", cps: 50, chance: 0, description: "A strict but fair Transfiguration teacher." },
      { name: "Ella", rarity: "Special", emoji: "ü¶ñ", cps: 50, chance: 0, description: "Rawr..." },
      { name: "Nirvi", rarity: "Special", emoji: "üêí", cps: 40, chance: 0, description: "A peculiar monkey." },
      { name: "Matthew Tan", rarity: "Special", emoji: "ü§Ø", cps: 45, chance: 0,description: "Thinks he's smart." }
    ];

    function generateChecksum(state) {
      const coinSum = state.coins || 0;
      const spinCostSum = state.spinCost || 0;
      const inventoryCount = state.inventory ? state.inventory.length : 0;
      const equippedCount = state.equipped ? state.equipped.filter(item => item !== null).length : 0;
      const forgeCount = state.forgeSlots ? state.forgeSlots.filter(item => item !== null).length : 0;
      const altarTargetCount = state.altarTarget ? 1 : 0;
      const altarFuelCount = state.altarFuel ? state.altarFuel.filter(item => item !== null).length : 0;
      const changelogCount = state.changelog ? state.changelog.length : 0;
      return (coinSum + spinCostSum + inventoryCount + equippedCount + forgeCount + altarTargetCount + altarFuelCount + changelogCount) % 1000;
    }

    function validateState(state) {
      if (!state || typeof state !== 'object') return false;

      if (typeof state.coins !== 'number' || state.coins < 0 || state.coins > 1e9) return false;
      if (typeof state.spinCost !== 'number' || state.spinCost < 10 || state.spinCost > 1e6) return false;

      if (!Array.isArray(state.inventory) || state.inventory.length > 1000) return false;
      for (let item of state.inventory) {
        if (!item || !items.some(base => 
          base.name === item.name && 
          base.rarity === item.rarity && 
          (base.cps === item.cps || (item.cps > base.cps && item.cps <= 1000)) && 
          base.emoji === item.emoji && 
          base.description === item.description
        )) {
          if (!state.inventory.some(forged => 
            forged.name === item.name && 
            rarityProgression.indexOf(item.rarity) > rarityProgression.indexOf(forged.rarity) && 
            item.cps >= forged.cps && item.cps <= 1000
          )) return false;
        }
      }

      if (!Array.isArray(state.equipped) || state.equipped.length !== 5) return false;
      for (let item of state.equipped) {
        if (item && !items.some(base => 
          base.name === item.name && 
          base.rarity === item.rarity && 
          (base.cps === item.cps || (item.cps > base.cps && item.cps <= 1000)) && 
          base.emoji === item.emoji && 
          base.description === item.description
        )) {
          if (!state.inventory.some(forged => 
            forged.name === item.name && 
            rarityProgression.indexOf(item.rarity) > rarityProgression.indexOf(forged.rarity) && 
            item.cps >= forged.cps && item.cps <= 1000
          )) return false;
        }
      }

      if (!Array.isArray(state.forgeSlots) || state.forgeSlots.length !== 3) return false;
      for (let item of state.forgeSlots) {
        if (item && !items.some(base => 
          base.name === item.name && 
          base.rarity === item.rarity && 
          (base.cps === item.cps || (item.cps > base.cps && item.cps <= 1000)) && 
          base.emoji === item.emoji && 
          base.description === item.description
        )) {
          if (!state.inventory.some(forged => 
            forged.name === item.name && 
            rarityProgression.indexOf(item.rarity) > rarityProgression.indexOf(forged.rarity) && 
            item.cps >= forged.cps && item.cps <= 1000
          )) return false;
        }
      }

      if (state.altarTarget && !items.some(base => 
        base.name === state.altarTarget.name && 
        base.rarity === state.altarTarget.rarity && 
        (base.cps === state.altarTarget.cps || (state.altarTarget.cps > base.cps && state.altarTarget.cps <= 1000)) && 
        base.emoji === state.altarTarget.emoji && 
        base.description === state.altarTarget.description
      )) {
        if (!state.inventory.some(forged => 
          forged.name === state.altarTarget.name && 
          rarityProgression.indexOf(state.altarTarget.rarity) > rarityProgression.indexOf(forged.rarity) && 
          state.altarTarget.cps >= forged.cps && state.altarTarget.cps <= 1000
        )) return false;
      }

      if (!Array.isArray(state.altarFuel) || state.altarFuel.length !== 5) return false;
      for (let item of state.altarFuel) {
        if (item && !items.some(base => 
          base.name === item.name && 
          base.rarity === item.rarity && 
          (base.cps === item.cps || (item.cps > base.cps && item.cps <= 1000)) && 
          base.emoji === item.emoji && 
          base.description === item.description
        )) {
          if (!state.inventory.some(forged => 
            forged.name === item.name && 
            rarityProgression.indexOf(item.rarity) > rarityProgression.indexOf(forged.rarity) && 
            item.cps >= forged.cps && item.cps <= 1000
          )) return false;
        }
      }

      if (!Array.isArray(state.redeemedCodes)) return false;
      const validCodes = ['a2V5YnVnMDI=', 'Y29kZVByb01j', 'dXBkYXRlY2hhbmdlbG9n'];
      for (let code of state.redeemedCodes) {
        if (!validCodes.includes(code)) return false;
      }

      if (!Array.isArray(state.changelog) || state.changelog.length > 50) return false;
      for (let entry of state.changelog) {
        if (!entry.text || !entry.timestamp || typeof entry.text !== 'string' || typeof entry.timestamp !== 'string' || entry.text.length > 200) {
          return false;
        }
      }

      return true;
    }

    function saveGame(showCode = false) {
      try {
        const state = {
          coins,
          spinCost,
          inventory,
          equipped,
          forgeSlots,
          altarTarget,
          altarFuel,
          redeemedCodes: Array.from(redeemedCodes),
          changelog
        };
        const checksum = generateChecksum(state);
        const json = JSON.stringify(state);
        const encoded = btoa(encodeURIComponent(json)) + '.' + checksum;
        localStorage.setItem('lootSpinState', encoded);
        if (showCode) {
          const saveCodeEl = document.getElementById('saveCode');
          saveCodeEl.value = encoded;
          alert('Game saved! Copy the code from the textarea for backup.');
        }
      } catch (e) {
        alert('Failed to save game: ' + e.message);
      }
    }

    function loadGame() {
      const saveCodeEl = document.getElementById('saveCode');
      let encoded = saveCodeEl.value.trim();
      if (!encoded) {
        encoded = localStorage.getItem('lootSpinState') || '';
      }
      if (!encoded) {
        alert('No save code provided or saved game found!');
        return;
      }

      try {
        const [data, checksum] = encoded.split('.');
        const json = decodeURIComponent(atob(data));
        const state = JSON.parse(json);
        const expectedChecksum = generateChecksum(state);

        if (parseInt(checksum) !== expectedChecksum) {
          alert('Invalid save code: Checksum mismatch!');
          return;
        }

        if (!validateState(state)) {
          alert('Invalid save code: Data is corrupted or tampered!');
          return;
        }

        coins = state.coins;
        spinCost = state.spinCost;
        inventory.length = 0;
        inventory.push(...state.inventory);
        equipped.length = 0;
        equipped.push(...state.equipped);
        forgeSlots.length = 0;
        forgeSlots.push(...state.forgeSlots);
        altarTarget = state.altarTarget;
        altarFuel.length = 0;
        altarFuel.push(...state.altarFuel);
        redeemedCodes.clear();
        state.redeemedCodes.forEach(code => redeemedCodes.add(code));
        changelog.length = 0;
        changelog.push(...state.changelog);

        updateInventory();
        updateSpinButton();
        updateForgeSlots();
        updateSlots();
        updateForgableList();
        updateAltarTarget();
        updateFuelSlots();
        updateFuelCardList();
        updateChangelog();
        saveCodeEl.value = '';
        alert('Game loaded successfully!');
      } catch (e) {
        alert('Failed to load game: Invalid save code!');
      }
    }

    window.onload = () => {
  loadGame();
  // Validate slot states in place
  for (let i = 0; i < forgeSlots.length; i++) {
    forgeSlots[i] = forgeSlots[i] && forgeSlots[i].rarity && forgeSlots[i].name && Number.isInteger(forgeSlots[i].cps) && forgeSlots[i].cps >= 0 ? forgeSlots[i] : null;
  }
  altarTarget = altarTarget && altarTarget.rarity && altarTarget.name && Number.isInteger(altarTarget.cps) && altarTarget.cps >= 0 ? altarTarget : null;
  for (let i = 0; i < altarFuel.length; i++) {
    altarFuel[i] = altarFuel[i] && altarFuel[i].rarity && altarFuel[i].name && Number.isInteger(altarFuel[i].cps) && altarFuel[i].cps >= 0 ? altarFuel[i] : null;
  }
  for (let i = 0; i < equipped.length; i++) {
    equipped[i] = equipped[i] && equipped[i].rarity && equipped[i].name && Number.isInteger(equipped[i].cps) && equipped[i].cps >= 0 ? equipped[i] : null;
  }
  // Log equipped for debugging
  console.log('Equipped items:', equipped);
  // Ensure coins is valid
  if (typeof coins !== 'number' || isNaN(coins) || coins < 0) {
    coins = 100;
    console.log('Reset coins to 100');
  }
  // Clear inline backgrounds
  document.querySelectorAll('.forge-slot, .target-slot, .fuel-slot, .slot-content').forEach(el => {
    el.style.background = '';
  });
  updateInventory();
  updateSlots();
  updateForgeSlots();
  updateAltarTarget();
  updateFuelSlots();
  updateForgableList();
  updateFuelCardList();
  updateChangelog();
  updateSpinButton();
  setInterval(() => {
    collectCoins();
    console.log('collectCoins called');
  }, 1000);

  // Add event listeners for batch selection
  const batchRarity = document.getElementById('batchRarity');
  const batchCPS = document.getElementById('batchCPS');
  const batchButton = document.querySelector('.batch-selection button');
  batchRarity.addEventListener('change', () => batchButton.disabled = !batchRarity.value && !batchCPS.value);
  batchCPS.addEventListener('input', () => batchButton.disabled = !batchRarity.value && !batchCPS.value);
};

function collectCoins() {
  let totalCPS = 0;
  equipped.forEach(item => {
    if (item && Number.isInteger(item.cps) && item.cps >= 0) {
      totalCPS += item.cps;
    }
  });
  console.log('collectCoins: equipped=', equipped, 'totalCPS=', totalCPS, 'coins=', coins);
  coins += totalCPS;
  updateSpinButton();
  if (totalCPS > 0) {
    const coinCounter = document.getElementById('coinCounter');
    coinCounter.parentElement.classList.add('sparkle');
    setTimeout(() => coinCounter.parentElement.classList.remove('sparkle'), 500);
  }
  saveGame();
}
    function spin() {
      if (coins < spinCost) {
        alert("Not enough coins!");
        return;
      }
      coins -= spinCost;
      spinCost += 10;
      updateSpinButton();
      
      const totalChance = items.reduce((sum, item) => sum + item.chance, 0);
      let roll = Math.random() * totalChance;
      let cumulative = 0;
      let selectedItem = null;
      
      for (let item of items) {
        cumulative += item.chance;
        if (roll < cumulative) {
          selectedItem = { ...item };
          break;
        }
      }
      
      if (selectedItem) {
        if (inventory.length >= 1000) {
          alert("Inventory full! Please clear some items.");
          return;
        }
        inventory.push(selectedItem);
        showResult(selectedItem);
        updateInventory();
        
        if (selectedItem.rarity === "Celestial" || selectedItem.rarity === "Special") {
          showSpecialMessage(selectedItem);
        }
      }
      saveGame();
    }

    function showSpecialMessage(item) {
      const specialDiv = document.createElement('div');
      specialDiv.className = 'special-message';
      
      specialDiv.innerHTML = `
        <div class="special-content">
          <div class="special-title ${item.rarity}">‚ú® ${item.rarity.toUpperCase()} ITEM! ‚ú®</div>
          <div class="special-item">${item.name} ${item.emoji}</div>
          <div>${item.description}</div>
          <div class="description-text">Generates ${item.cps} coins/sec!</div>
          <button class="close-special" onclick="this.parentElement.parentElement.remove()">
            CELEBRATE!
          </button>
        </div>
      `;
      
      document.body.appendChild(specialDiv);
      createConfetti(item.rarity);
    }

    function createConfetti(rarity) {
      const colorMap = {
        Celestial: ['#00b7eb', '#0097c7', '#e6f7ff'],
        Special: ['#dc143c', '#ff4500', '#ffd700']
      };
      const colors = colorMap[rarity] || ['#ff0000', '#ff4500', '#ffd700', '#ffffff'];
      const confettiContainer = document.getElementById('confettiContainer');
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        const leftPos = Math.random() < 0.5 ? Math.random() * 30 : 70 + Math.random() * 30;
        confetti.style.left = leftPos + 'vw';
        confetti.style.top = -10 + 'px';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        
        const size = Math.random() * 10 + 5;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        
        confettiContainer.appendChild(confetti);
        
        const animationDuration = Math.random() * 3 + 2;
        
        confetti.animate([
          { top: '-10px', opacity: 1, transform: `rotate(${Math.random() * 360}deg)` },
          { top: '100vh', opacity: 0, transform: `rotate(${Math.random() * 360}deg)` }
        ], {
          duration: animationDuration * 1000,
          easing: 'cubic-bezier(0.1, 0.8, 0.9, 1)'
        });
        
        setTimeout(() => confetti.remove(), animationDuration * 1000);
      }
    }

    function showResult(item) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `
        <div>üéâ You won: ${item.name} ${item.emoji}</div>
        <div class="description-text">Description: ${item.description}</div>
        <div class="description-text">Generates ${item.cps} coins/sec</div>
      `;
      resultDiv.className = `item-card ${item.rarity}`;
    }

    function updateSpinButton() {
      const coinCounter = document.getElementById("coinCounter");
      const spinCostEl = document.getElementById("spinCost");
      coinCounter.textContent = Math.floor(coins);
      spinCostEl.textContent = spinCost;
    }

    function updateInventory(forgedCardName = null) {
  const list = document.getElementById("inventoryList");
  list.innerHTML = "";
  const sorted = [...inventory].sort((a, b) => {
    if (b.cps !== a.cps) return b.cps - a.cps;
    if (rarityOrder[b.rarity] !== rarityOrder[a.rarity]) return rarityOrder[b.rarity] - rarityOrder[a.rarity];
    return a.name.localeCompare(b.name);
  });
  sorted.forEach((item, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${item.name} ${item.emoji} (${item.rarity})
      <div class="description-text">${item.cps} coins/sec</div>
      <span class="tooltip">${item.description}</span>
    `;
    li.className = `${item.rarity}-li`;
    if (forgedCardName && item.name === forgedCardName && item.rarity === forgedCardName.rarity) {
      li.classList.add('forged-card');
      setTimeout(() => li.classList.remove('forged-card'), 1000);
    }
    li.dataset.index = inventory.indexOf(item);
    li.addEventListener('click', () => selectItem(item, li, 'inventory'));
    if (selectedItem && selectedItem.name === item.name && selectedItem.rarity === item.rarity && selectedItem.cps === item.cps && selectedSource === 'inventory') {
      li.classList.add('selected');
    }
    list.appendChild(li);
  });
  updateForgableList();
  updateFuelCardList();
}

    function updateForgableList() {
      const list = document.getElementById("forgableList");
      list.innerHTML = "";
      
      const itemCounts = {};
      inventory.forEach(item => {
        if (item.rarity !== "Special") {
          const key = `${item.name}|${item.rarity}`;
          if (!itemCounts[key]) {
            itemCounts[key] = { count: 0, item: item };
          }
          itemCounts[key].count++;
        }
      });

      const forgableItems = Object.values(itemCounts)
        .filter(data => data.count >= 3)
        .map(data => ({
          ...data.item,
          count: data.count
        }));

      const sorted = forgableItems.sort((a, b) => {
        if (b.cps !== a.cps) return b.cps - a.cps;
        if (rarityOrder[b.rarity] !== rarityOrder[a.rarity]) return rarityOrder[b.rarity] - rarityOrder[a.rarity];
        return a.name.localeCompare(b.name);
      });

      sorted.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${item.name} ${item.emoji} (${item.rarity}, x${item.count})
          <div class="description-text">${item.cps} coins/sec</div>
          <span class="tooltip">${item.description}</span>
        `;
        li.className = `${item.rarity}-li`;
        li.addEventListener('click', () => selectItem(item, li, 'forgable'));
        if (selectedItem && selectedItem.name === item.name && selectedItem.rarity === item.rarity && selectedSource === 'forgable') {
          li.classList.add('selected');
        }
        list.appendChild(li);
      });
    }

    function updateFuelCardList() {
      const list = document.getElementById("fuelCardList");
      list.innerHTML = "";
      
      const itemCounts = {};
      inventory.forEach(item => {
        const key = `${item.name}|${item.rarity}`;
        if (!itemCounts[key]) {
          itemCounts[key] = { count: 0, item: item };
        }
        itemCounts[key].count++;
      });

      const fuelItems = Object.values(itemCounts).map(data => ({
        ...data.item,
        count: data.count
      }));

      const sorted = fuelItems.sort((a, b) => {
        if (b.cps !== a.cps) return b.cps - a.cps;
        if (rarityOrder[b.rarity] !== rarityOrder[a.rarity]) return rarityOrder[b.rarity] - rarityOrder[a.rarity];
        return a.name.localeCompare(b.name);
      });

      sorted.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${item.name} ${item.emoji} (${item.rarity}, x${item.count})
          <div class="description-text">${item.cps} coins/sec</div>
          <span class="tooltip">${item.description}</span>
        `;
        li.className = `${item.rarity}-li`;
        li.addEventListener('click', () => selectItem(item, li, 'fuel'));
        if (selectedItem && selectedItem.name === item.name && selectedItem.rarity === item.rarity && selectedSource === 'fuel') {
          li.classList.add('selected');
        }
        list.appendChild(li);
      });
    }

    function updateChangelog() {
      const list = document.getElementById("changelogList");
      list.innerHTML = `
        <li>Designed by <a onclick="window.open('https://github.com/ElyakProductionsCo', '_blank')">ElyakProductionsCo</a></li>
      `;
      changelog.slice().reverse().forEach(entry => {
        const li = document.createElement("li");
        li.textContent = `${entry.timestamp}: ${entry.text}`;
        list.insertBefore(li, list.firstChild.nextSibling);
      });
    }

    function addChangelogEntry() {
      const entry = prompt("Enter changelog entry (max 200 characters):");
      if (entry && entry.trim() && entry.length <= 200) {
        const timestamp = new Date().toISOString().replace('T', ' ').slice(0, 19);
        changelog.push({ text: entry.trim(), timestamp });
        if (changelog.length > 50) {
          changelog.shift();
        }
        updateChangelog();
        saveGame();
        alert("Changelog updated!");
      } else if (entry) {
        alert("Entry must be non-empty and up to 200 characters!");
      }
    }

    function selectItem(item, element, source) {
  if (selectedItem && selectedItem.name === item.name && selectedItem.rarity === item.rarity && selectedItem.cps === item.cps && selectedSource === source) {
    selectedItem = null;
    selectedSource = null;
    updateInventory();
    updateForgableList();
    updateFuelCardList();
  } else {
    selectedItem = item;
    selectedSource = source;
    if (source === 'forgable') {
      autoPlaceForgable(item);
    } else if (source === 'fuel') {
      autoPlaceFuel(item);
    } else {
      updateInventory();
      updateForgableList();
      updateFuelCardList();
    }
  }
}

function autoPlaceForgable(item) {
  const matchingItems = inventory.filter(i => i.name === item.name && i.rarity === item.rarity);
  if (matchingItems.length < 3) {
    alert("Not enough matching items in inventory!");
    selectedItem = null;
    selectedSource = null;
    updateInventory();
    updateForgableList();
    return;
  }
  forgeSlots.forEach((slotItem, i) => {
    if (slotItem) {
      inventory.push(slotItem);
      forgeSlots[i] = null;
    }
  });
  for (let i = 0; i < 3; i++) {
    forgeSlots[i] = { ...matchingItems[i] };
  }
  let removedCount = 0;
  for (let i = inventory.length - 1; i >= 0 && removedCount < 3; i--) {
    if (inventory[i].name === item.name && inventory[i].rarity === item.rarity) {
      inventory.splice(i, 1);
      removedCount++;
    }
  }
  selectedItem = null;
  selectedSource = null;
  updateInventory();
  updateForgeSlots();
  updateForgableList();
  saveGame();
}

function autoPlaceFuel(item) {
  if (altarTarget && item.name === altarTarget.name && item.rarity === altarTarget.rarity && item.cps === altarTarget.cps) {
    alert("Cannot use the target card as a fuel card!");
    selectedItem = null;
    selectedSource = null;
    updateInventory();
    updateFuelCardList();
    return;
  }
  const matchingItems = inventory.filter(i => i.name === item.name && i.rarity === item.rarity && i.cps === item.cps);
  if (matchingItems.length < 1) {
    alert("Not enough matching items in inventory!");
    selectedItem = null;
    selectedSource = null;
    updateInventory();
    updateFuelCardList();
    return;
  }
  const emptySlotIndex = altarFuel.findIndex(slot => slot === null);
  if (emptySlotIndex === -1) {
    alert("All fuel slots are filled!");
    selectedItem = null;
    selectedSource = null;
    updateInventory();
    updateFuelCardList();
    return;
  }
  altarFuel[emptySlotIndex] = { ...matchingItems[0] };
  const itemIndex = inventory.findIndex(i => 
    i.name === item.name && i.rarity === item.rarity && i.cps === item.cps
  );
  if (itemIndex !== -1) {
    inventory.splice(itemIndex, 1);
  }
  selectedItem = null;
  selectedSource = null;
  updateInventory();
  updateFuelSlots();
  updateFuelCardList();
  saveGame();
}

    function placeItemInSlot(slotIndex) {
      if (!selectedItem || selectedSource !== 'inventory') {
        alert("Please select an item from the inventory!");
        return;
      }
      if (equipped[slotIndex]) {
        inventory.push(equipped[slotIndex]);
      }
      equipped[slotIndex] = { ...selectedItem };
      const itemIndex = inventory.indexOf(selectedItem);
      if (itemIndex !== -1) {
        inventory.splice(itemIndex, 1);
      }
      selectedItem = null;
      selectedSource = null;
      updateInventory();
      updateSlots();
      saveGame();
    }

    function removeFromEquippedSlot(slotIndex) {
      if (equipped[slotIndex]) {
        inventory.push(equipped[slotIndex]);
        equipped[slotIndex] = null;
        selectedItem = null;
        selectedSource = null;
        updateInventory();
        updateSlots();
        saveGame();
      }
    }

    function updateSlots() {
  const slots = document.getElementById("slots");
  slots.querySelectorAll('.slot').forEach((slot, i) => {
    const slotContent = slot.querySelector('.slot-content');
    slotContent.style.background = ''; // Clear inline background
    if (equipped[i] && equipped[i].rarity && equipped[i].name) {
      slotContent.innerHTML = `
        ${equipped[i].name} ${equipped[i].emoji}<br>
        <span class="description-text">${equipped[i].cps} cps</span>
        <span class="tooltip">${equipped[i].description}</span>
      `;
      slot.className = `slot ${equipped[i].rarity}`;
      slotContent.className = `slot-content ${equipped[i].rarity}`;
    } else {
      slotContent.innerHTML = `Slot ${i + 1}`;
      slot.className = 'slot';
      slotContent.className = 'slot-content';
      slotContent.style.background = 'none';
    }
    slot.onclick = () => {
      if (selectedItem && selectedSource === 'inventory') {
        placeItemInSlot(i);
      } else if (equipped[i]) {
        removeFromEquippedSlot(i);
      }
    };
  });
}

function placeItemInForgeSlot(slotIndex) {
  if (!selectedItem || selectedSource !== 'inventory') {
    alert("Please select an item from the inventory!");
    return;
  }
  if (forgeSlots[slotIndex]) {
    inventory.push(forgeSlots[slotIndex]);
  }
  forgeSlots[slotIndex] = { ...selectedItem };
  const itemIndex = inventory.findIndex(item => 
    item.name === selectedItem.name && item.rarity === selectedItem.rarity && item.cps === selectedItem.cps
  );
  if (itemIndex !== -1) {
    inventory.splice(itemIndex, 1);
  }
  selectedItem = null;
  selectedSource = null;
  updateInventory();
  updateForgeSlots();
  saveGame();
}

    function removeFromForgeSlot(slotIndex) {
      if (forgeSlots[slotIndex]) {
        inventory.push(forgeSlots[slotIndex]);
        forgeSlots[slotIndex] = null;
        selectedItem = null;
        selectedSource = null;
        updateInventory();
        updateForgeSlots();
        saveGame();
      }
    }

    function updateForgeSlots() {
  const slots = document.querySelectorAll('.forge-slot');
  slots.forEach((slot, i) => {
    slot.innerHTML = forgeSlots[i] ? `${forgeSlots[i].name} ${forgeSlots[i].emoji} (${forgeSlots[i].rarity})` : '';
    slot.className = `forge-slot ${forgeSlots[i] ? forgeSlots[i].rarity : ''}`;
    slot.onclick = () => {
      if (forgeSlots[i]) {
        inventory.push(forgeSlots[i]);
        forgeSlots[i] = null;
        updateInventory();
        updateForgeSlots();
        saveGame();
      } else {
        placeItemInForgeSlot(i);
      }
    };
  });
}

    function forgeCards() {
      if (forgeSlots.some(slot => !slot)) {
        alert("Please fill all 3 forge slots!");
        return;
      }

      const allSame = forgeSlots.every((slot, i, arr) => 
        slot.name === arr[0].name && slot.rarity === arr[0].rarity
      );

      if (!allSame) {
        alert("All forge slots must contain the same item (name and rarity)!");
        return;
      }

      const baseItem = forgeSlots[0];
      if (baseItem.rarity === "Special") {
        alert("Special items cannot be forged!");
        return;
      }

      const currentRarityIndex = rarityProgression.indexOf(baseItem.rarity);
      let newRarity = baseItem.rarity;

      if (currentRarityIndex < rarityProgression.length - 1) {
        newRarity = rarityProgression[currentRarityIndex + 1];
      }

      const newItem = {
        ...baseItem,
        rarity: newRarity,
        cps: Math.floor(baseItem.cps * 4)
      };

      inventory.push(newItem);
      forgeSlots.fill(null);
      selectedItem = null;
      selectedSource = null;
      updateInventory(newItem);
      updateForgeSlots();
      saveGame();
    }

    function placeItemInAltarTarget() {
  if (!selectedItem || selectedSource !== 'inventory') {
    alert("Please select a target card from the inventory!");
    return;
  }
  if (altarTarget) {
    inventory.push(altarTarget);
  }
  altarTarget = { ...selectedItem };
  const itemIndex = inventory.findIndex(item => 
    item.name === selectedItem.name && 
    item.rarity === selectedItem.rarity && 
    item.cps === selectedItem.cps
  );
  if (itemIndex !== -1) {
    inventory.splice(itemIndex, 1);
  }
  selectedItem = null;
  selectedSource = null;
  updateInventory();
  updateAltarTarget();
  updateFuelCardList();
  saveGame();
}

    function removeFromAltarTarget() {
      if (altarTarget) {
        inventory.push(altarTarget);
        altarTarget = null;
        selectedItem = null;
        selectedSource = null;
        updateInventory();
        updateAltarTarget();
        saveGame();
      }
    }

    function updateAltarTarget() {
  const targetSlot = document.getElementById("altarTarget");
  targetSlot.style.background = ''; // Clear inline background
  if (altarTarget && altarTarget.rarity && altarTarget.name) {
    targetSlot.innerHTML = `
      ${altarTarget.name} ${altarTarget.emoji}
      <div class="description-text">${altarTarget.cps} cps</div>
      <span class="tooltip">${altarTarget.description}</span>
    `;
    targetSlot.className = `target-slot ${altarTarget.rarity}`;
  } else {
    targetSlot.innerHTML = `Target Slot`;
    targetSlot.className = 'target-slot';
    targetSlot.style.background = 'rgba(255,255,255,0.05)';
  }
  targetSlot.onclick = () => {
    if (selectedItem && selectedSource === 'inventory') {
      placeItemInAltarTarget();
    } else if (altarTarget) {
      removeFromAltarTarget();
    }
  };
}

function placeItemInFuelSlot(slotIndex) {
  if (!selectedItem || selectedSource !== 'inventory') {
    alert("Please select a fuel card from the inventory!");
    return;
  }
  if (altarTarget && selectedItem.name === altarTarget.name && selectedItem.rarity === altarTarget.rarity && selectedItem.cps === altarTarget.cps) {
    alert("Cannot use the target card as a fuel card!");
    return;
  }
  if (altarFuel[slotIndex]) {
    inventory.push(altarFuel[slotIndex]);
  }
  altarFuel[slotIndex] = { ...selectedItem };
  const itemIndex = inventory.findIndex(item => 
    item.name === selectedItem.name && item.rarity === selectedItem.rarity && item.cps === selectedItem.cps
  );
  if (itemIndex !== -1) {
    inventory.splice(itemIndex, 1);
  }
  selectedItem = null;
  selectedSource = null;
  updateInventory();
  updateFuelSlots();
  updateFuelCardList();
  saveGame();
}

    function removeFromFuelSlot(slotIndex) {
      if (altarFuel[slotIndex]) {
        inventory.push(altarFuel[slotIndex]);
        altarFuel[slotIndex] = null;
        selectedItem = null;
        selectedSource = null;
        updateInventory();
        updateFuelSlots();
        saveGame();
      }
    }

    function updateFuelSlots() {
  const slots = document.querySelectorAll('.fuel-slot');
  slots.forEach((slot, i) => {
    slot.innerHTML = altarFuel[i] ? `${altarFuel[i].name} ${altarFuel[i].emoji} (${altarFuel[i].rarity}) ${altarFuel[i].cps} CPS` : '';
    slot.className = `fuel-slot ${altarFuel[i] ? altarFuel[i].rarity : ''}`;
    slot.onclick = () => {
      if (altarFuel[i]) {
        inventory.push(altarFuel[i]);
        altarFuel[i] = null;
        updateInventory();
        updateFuelSlots();
        updateFuelCardList();
        saveGame();
      } else {
        placeItemInFuelSlot(i);
      }
    };
  });
}

function batchSelectFuelCards() {
  const raritySelect = document.getElementById('batchRarity').value;
  const cpsInput = document.getElementById('batchCPS').value;
  const cpsValue = cpsInput ? parseInt(cpsInput) : null;

  if (!raritySelect && (!cpsValue || isNaN(cpsValue) || cpsValue < 0 || cpsValue > 1000)) {
    alert("Please select a rarity or enter a valid CPS (0 to 1000)!");
    document.getElementById('batchCPS').focus();
    return;
  }

  if (inventory.length === 0) {
    alert("Inventory is empty! Add items to use batch selection.");
    updateFuelSlots();
    updateFuelCardList();
    saveGame();
    return;
  }

  // Clear existing fuel slots
  altarFuel.forEach((slotItem, i) => {
    if (slotItem) {
      inventory.push(slotItem);
      altarFuel[i] = null;
    }
  });

  // Filter inventory for matching items
  let matchingItems = inventory.filter(item => {
    const matchesRarity = raritySelect ? item.rarity === raritySelect : true;
    const matchesCPS = cpsValue !== null ? item.cps === cpsValue : true;
    const notTarget = !altarTarget || 
      (item.name !== altarTarget.name || item.rarity !== altarTarget.rarity || item.cps !== altarTarget.cps);
    return matchesRarity && matchesCPS && notTarget;
  });

  if (matchingItems.length === 0) {
    alert("No items match the selected criteria!");
    updateFuelSlots();
    updateFuelCardList();
    saveGame();
    return;
  }

  // Sort by CPS descending
  matchingItems.sort((a, b) => b.cps - a.cps);

  // Fill up to 5 fuel slots
  const fillCount = Math.min(matchingItems.length, altarFuel.length);
  for (let i = 0; i < fillCount; i++) {
    altarFuel[i] = { ...matchingItems[i] };
  }

  // Remove selected items from inventory
  for (let i = 0; i < fillCount; i++) {
    const itemIndex = inventory.findIndex(item => 
      item.name === matchingItems[i].name && 
      item.rarity === matchingItems[i].rarity && 
      item.cps === matchingItems[i].cps
    );
    if (itemIndex !== -1) {
      inventory.splice(itemIndex, 1);
    }
  }

  updateInventory();
  updateFuelSlots();
  updateFuelCardList();
  saveGame();
}

function upgradeCard() {
  if (!altarTarget) {
    alert("Please place a target card in the altar!");
    return;
  }

  const filledFuelSlots = altarFuel.filter(slot => slot !== null);
  if (filledFuelSlots.length < 3) {
    alert("Please place at least 3 fuel cards!");
    return;
  }

  const totalFuelCPS = filledFuelSlots.reduce((sum, item) => sum + item.cps, 0);
  const cpsIncrease = Math.floor(totalFuelCPS * 0.5);
  const newCPS = Math.min(altarTarget.cps + cpsIncrease, 1000);
  altarTarget.cps = newCPS;

  inventory.push({ ...altarTarget });
  altarTarget = null;
  altarFuel.fill(null);

  selectedItem = null;
  selectedSource = null;
  updateInventory();
  updateAltarTarget();
  updateFuelSlots();
  updateFuelCardList();
  saveGame();
  alert(`Card upgraded! New CPS: ${newCPS}`);
}

function redeemCode() {
  const codeInput = document.getElementById('codeInput');
  const code = codeInput.value.trim();
  const encodedCode = btoa(code);

  if (redeemedCodes.has(encodedCode)) {
    alert('This code has already been redeemed!');
    return;
  }

  if (code === 'imabeggar') {
    coins += 100;
    spinCost = 10;
    redeemedCodes.add(encodedCode);
    updateSpinButton();
    saveGame();
    alert('Code redeemed! + 1000 coins, spin cost reset.');
  } else if (code === 'ilovehomework') {
    const mcgonagall = items.find(item => item.name === "Professor McGonagall");
    if (mcgonagall) {
      inventory.push({ ...mcgonagall });
      redeemedCodes.add(encodedCode);
      updateInventory();
      showSpecialMessage(mcgonagall);
      saveGame();
      alert('Code redeemed! Professor McGonagall added to inventory.');
    }
  } else if (code == 'Ella') {
    const ella = items.find(item => item.name === "Ella");
    if (ella) {
      inventory.push({...ella});
      redeemedCodes.add(encodedCode);
      updateInventory();
      showSpecialMessage(ella);
      saveGame();
      alert('Code redeemed! Ella added to inventory.');
    }
  } else if (code == 'Nirvi') {
    const nirvi = items.find(item => item.name === "Nirvi");
    if (nirvi) {
      inventory.push({...nirvi});
      redeemedCodes.add(encodedCode);
      updateInventory();
      showSpecialMessage(nirvi);
      saveGame();
      alert('Code redeemed! Nirvi added to inventory.');
    }
  } else if (code == 'Idiot') {
    const idiot = items.find(item => item.name === "Matthew Tan");
    if (idiot) {
      inventory.push({...idiot});
      redeemedCodes.add(encodedCode);
      updateInventory();
      showSpecialMessage(idiot);
      saveGame();
      alert('Code redeemed! Matthew Tan added to inventory.');
    }
  } else if (code === 'keybug02') {
    addChangelogEntry();
    redeemedCodes.add(encodedCode);
    alert('-welcome, developer-');
  } else {
    alert('Invalid code!');
  }

  codeInput.value = '';
}
</script>
